# 球面谐波的理论与实践

球谐光照就是用 N 个多项式拟合一个位置的低频光照函数，主要用到的就是球面谐波（Spherical Harmonics, SH）。下面先回顾相关数学基础，再推导球谐函数及其在光照中的应用。

相关： [蒙特卡洛方法](蒙特卡洛方法.md)、[重要度采样](重要度采样.md)。

## 球谐相关数学基础

### 期望

随机变量 $$X$$ 在分布 $$P$$ 下的**期望**定义为：

$$ E[X; P] = \int x \, dP(x) $$

用样本估计期望：$$\hat E[X,P] = \frac{1}{n} \sum_{i=1}^n x_i$$。估计的精度与 $$X$$ 的方差和样本数 $$n$$ 有关。

### 蒙特卡洛

蒙特卡洛积分用**随机采样**估计积分：对被积函数按某分布采样，对样本的函数值求平均，得到积分的近似。当抽样数为 $$m$$ 时，误差量级与 $$1/\sqrt{m}$$ 相关，与积分维数关系不大，因此高维积分时蒙特卡洛常优于数值积分。详见 [蒙特卡洛方法](蒙特卡洛方法.md)。

### 大数定理

**强大数定理**：若 $$\{X_i\}$$ 独立同分布且期望 $$E[X_i]=\mu$$ 存在，则

$$ Pr\left(\lim_{N \to \infty} \frac{1}{N} \sum_{i=1}^{N} X_i = \mu\right) = 1 $$

即样本均值几乎必然收敛到期望。这是用蒙特卡洛估计积分时“取平均”的理论依据。

### 随机数与球面坐标

在球面上采样时，常用**球面坐标** $$(\theta, \phi)$$：$$\theta \in [0, \pi]$$ 为极角（与法线的夹角），$$\phi \in [0, 2\pi)$$ 为方位角。单位方向 $$\omega$$ 与笛卡尔坐标的关系：

$$ \omega = (\sin\theta \cos\phi,\ \sin\theta \sin\phi,\ \cos\theta) $$

球面面积元 $$d\omega = \sin\theta \, d\theta \, d\phi$$。若在 $$[0,\pi]\times[0,2\pi)$$ 上均匀抽样 $$(\theta,\phi)$$，需按 $$\sin\theta$$ 做重要度采样，或先抽样 $$u=\cos\theta$$ 再得到 $$\theta=\arccos u$$，才能得到球面上均匀分布的方向。

### 正交基函数

一组函数 $$\{f_i\}$$ 在定义域上**正交**，指内积满足 $$\langle f_i, f_j \rangle = 0$$（$$i \neq j$$）。若还满足 $$\langle f_i, f_i \rangle = 1$$，则称为**标准正交基**。任意函数在标准正交基下可做投影与重建：投影系数 $$c_i = \langle f, f_i \rangle$$，重建 $$f \approx \sum_i c_i f_i$$。球面谐波就是在**单位球面**上的一组标准正交基。

### 正交多项式

勒让德多项式 $$P_l(x)$$（$$x \in [-1,1]$$）满足正交性：

$$ \int_{-1}^{1} P_l(x) P_{l'}(x) \, dx = \frac{2}{2l+1} \delta_{ll'} $$

关联勒让德函数 $$P_l^m(x)$$ 由 $$P_l$$ 求 $$m$$ 次导数并乘上 $$(1-x^2)^{m/2}$$ 得到，是球谐的径向部分。球面谐波可写成 $$\theta,\phi$$（或 $$x=\cos\theta,\phi$$）的函数，由这些正交多项式组合而成。

### 球谐

**球谐**是指在单位球面上满足**拉普拉斯方程**的一类特殊解，在球坐标下分离变量后，角度部分得到的就是球面谐波函数 $$Y_l^m$$。$$l$$ 为**阶**（band），$$m$$ 为 **-l 到 l** 的整数。低阶（$$l=0,1,2$$）对应低频，高阶对应高频；光照中常用低阶 SH 表示平滑环境光或漫反射。

### 球谐函数

**球面谐波函数**（实形式常用在图形学中）可写为：

$$ Y_l^m(\theta, \phi) = N_l^m \, P_l^{|m|}(\cos\theta) \, \Phi_m(\phi) $$

其中 $$N_l^m$$ 为归一化系数，$$P_l^{|m|}$$ 为关联勒让德函数，$$\Phi_m(\phi)$$ 为 $$\cos(m\phi)$$ 或 $$\sin(m\phi)$$。前几阶（$$l=0,1,2$$）的 SH 基在笛卡尔方向 $$\mathbf{n}=(x,y,z)$$ 下有简洁形式，例如：

- **L0**：常数项，1 个系数。
- **L1**：与 $$x,y,z$$ 线性相关，3 个系数。
- **L2**：二次项，5 个系数。

$$l$$ 阶共有 $$2l+1$$ 个基函数，前 3 阶（L0+L1+L2）共 **9 个**基，常用于漫反射光照。

### 球谐投影

将球面上的函数 $$f(\omega)$$ 投影到 SH 基上，得到系数：

$$ c_l^m = \int_{\mathcal{S}^2} f(\omega) \, Y_l^m(\omega) \, d\omega $$

即 $$c_l^m = \langle f, Y_l^m \rangle$$。实践中用**蒙特卡洛积分**估计：在球面上采样方向 $$\omega_i$$，计算

$$ c_l^m \approx \frac{4\pi}{N} \sum_{i=1}^{N} f(\omega_i) \, Y_l^m(\omega_i) $$

若采样均匀且 $$N$$ 足够大，估计收敛到真实投影系数。

### 球谐光照

**重建**：用系数恢复该位置的光照函数

$$ L(\omega) \approx \sum_{l=0}^{L} \sum_{m=-l}^{l} c_l^m \, Y_l^m(\omega) $$

**漫反射**：Lambert 漫反射在球面上积分可写成 SH 的卷积；若环境光用 SH 表示，则漫反射结果仍可写成 SH 的线性组合，系数可由预计算的**传递函数**（与法线、遮蔽等有关）得到。因此只需存储少量 SH 系数（如 9 个），即可在任意法线方向得到低频环境光漫反射，计算量小，适合实时渲染。

### 采样与计算

- **预计算阶段**：对环境贴图（或场景光照）在球面上采样，对每个采样方向 $$\omega_i$$ 计算光照值 $$L(\omega_i)$$，再按上式做蒙特卡洛求和得到各 $$c_l^m$$，存为 SH 系数（通常 L0+L1+L2，RGB 各 9 个共 27 个浮点数）。
- **运行时**：给定法线 $$\mathbf{n}$$，用 SH 基在 $$\mathbf{n}$$ 处的取值与系数做点积，得到该点的漫反射环境光。L0～L2 的基在 $$\mathbf{n}$$ 下都有解析式，实现为几句加减乘即可，无纹理采样，性能很好。
- **注意**：SH 只表达**低频**，高光、锐利阴影等高频信息会丢失，因此多用于环境漫反射或环境光遮蔽的近似，高光部分仍用 Cubemap 或其它方法。

---

**小结**：球面谐波是单位球面上的正交基，通过投影-重建可在少量系数下表示低频光照；结合蒙特卡洛投影与预计算的 SH 系数，可实现高效的球谐光照，常用于实时漫反射环境光。
